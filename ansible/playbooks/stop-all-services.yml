# Stop All Services Playbook
# Smart Attendance Management System
# Safely stops all running microservices

---
- name: Stop All Microservices
  hosts: localhost
  gather_facts: yes

  vars:
    # All service ports to stop
    service_ports:
      - port: 5000
        name: "API Gateway"
      - port: 5001
        name: "Student Service"
      - port: 5002
        name: "Course Service"
      - port: 5005
        name: "Attendance Service"
      - port: 5007
        name: "Auth Service"
      - port: 5008
        name: "Service Registry"

    project_root: /opt/smart-attendance

  tasks:
    # ========================================
    # PHASE 1: PRE-STOP CHECKS
    # ========================================

    - name: "ðŸ›‘ Display stop start message"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ðŸ›‘ STOPPING ALL MICROSERVICES"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ðŸ“Š Total Services: {{ service_ports | length }}"
          - "â° Stop Initiated: {{ ansible_date_time.iso8601 }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags:
        - always

    # ========================================
    # PHASE 2: CHECK RUNNING SERVICES
    # ========================================

    - name: "ðŸ” Check which services are running"
      shell: "lsof -ti:{{ item.port }} || echo 'not_running'"
      loop: "{{ service_ports }}"
      loop_control:
        label: "{{ item.name }} (Port {{ item.port }})"
      register: running_check
      changed_when: false
      failed_when: false
      tags:
        - check

    - name: "ðŸ“Š Display running services status"
      debug:
        msg: "{{ item.item.name }}: {{ 'RUNNING' if item.stdout != 'not_running' else 'NOT RUNNING' }}"
      loop: "{{ running_check.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      tags:
        - check

    # ========================================
    # PHASE 3: GRACEFUL SHUTDOWN (SIGTERM)
    # ========================================

    - name: "ðŸ”„ Attempt graceful shutdown (SIGTERM) for {{ item.item.name }}"
      shell: "kill -15 $(lsof -ti:{{ item.item.port }}) || true"
      loop: "{{ running_check.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: item.stdout != "not_running"
      register: graceful_shutdown
      tags:
        - stop
        - graceful

    - name: "â³ Wait 3 seconds for graceful shutdown"
      pause:
        seconds: 3
        prompt: "Waiting for services to shutdown gracefully..."
      when: graceful_shutdown.changed
      tags:
        - stop

    # ========================================
    # PHASE 4: CHECK IF STILL RUNNING
    # ========================================

    - name: "ðŸ” Check if services stopped gracefully"
      shell: "lsof -ti:{{ item.port }} || echo 'stopped'"
      loop: "{{ service_ports }}"
      loop_control:
        label: "{{ item.name }}"
      register: post_graceful_check
      changed_when: false
      failed_when: false
      tags:
        - verify

    # ========================================
    # PHASE 5: FORCE KILL IF NECESSARY (SIGKILL)
    # ========================================

    - name: "âš ï¸  Force kill {{ item.item.name }} (SIGKILL)"
      shell: "kill -9 $(lsof -ti:{{ item.item.port }}) || true"
      loop: "{{ post_graceful_check.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: item.stdout != "stopped" and item.stdout != ""
      register: force_kill
      tags:
        - stop
        - force

    - name: "â³ Wait 2 seconds after force kill"
      pause:
        seconds: 2
      when: force_kill.changed
      tags:
        - stop

    # ========================================
    # PHASE 6: FINAL VERIFICATION
    # ========================================

    - name: "âœ… Verify all ports are free"
      wait_for:
        port: "{{ item.port }}"
        state: stopped
        timeout: 5
      loop: "{{ service_ports }}"
      loop_control:
        label: "{{ item.name }}:{{ item.port }}"
      register: port_verification
      failed_when: false
      tags:
        - verify

    - name: "ðŸ“Š Port status after stop"
      debug:
        msg: "Port {{ item.item.port }} ({{ item.item.name }}): {{ 'FREED âœ…' if not item.failed else 'STILL IN USE âš ï¸' }}"
      loop: "{{ port_verification.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      tags:
        - verify

    # ========================================
    # PHASE 7: CLEANUP
    # ========================================

    - name: "ðŸ§¹ Remove PID files"
      file:
        path: "{{ project_root }}/{{ item.name | lower | replace(' ', '-') }}/service.pid"
        state: absent
      loop: "{{ service_ports }}"
      loop_control:
        label: "{{ item.name }}"
      failed_when: false
      tags:
        - cleanup

    - name: "ðŸ§¹ Archive log files"
      shell: |
        if [ -f {{ project_root }}/{{ item.name | lower | replace(' ', '-') }}/service.log ]; then
          mv {{ project_root }}/{{ item.name | lower | replace(' ', '-') }}/service.log \
             {{ project_root }}/logs/{{ item.name | lower | replace(' ', '-') }}-{{ ansible_date_time.epoch }}.log || true
        fi
      loop: "{{ service_ports }}"
      loop_control:
        label: "{{ item.name }}"
      args:
        executable: /bin/bash
      failed_when: false
      tags:
        - cleanup

    # ========================================
    # PHASE 8: LOG SHUTDOWN
    # ========================================

    - name: "ðŸ“ Log shutdown event"
      lineinfile:
        path: "{{ project_root }}/deployment.log"
        line: "{{ ansible_date_time.iso8601 }} - ALL SERVICES STOPPED - Shutdown initiated by {{ ansible_user_id }}"
        create: yes
        mode: '0644'
      failed_when: false
      tags:
        - logging

    - name: "ðŸ“ Write shutdown summary"
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          SERVICES SHUTDOWN SUMMARY
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          Shutdown Time: {{ ansible_date_time.iso8601 }}
          Initiated By: {{ ansible_user_id }}

          SERVICES STOPPED:
          {% for item in service_ports %}
          - {{ item.name }} (Port {{ item.port }})
          {% endfor %}

          METHOD USED:
          1. Graceful shutdown (SIGTERM) attempted first
          2. Force kill (SIGKILL) used if necessary
          3. All ports verified as freed

          CLEANUP PERFORMED:
          - PID files removed
          - Log files archived to {{ project_root }}/logs/

          STATUS: All {{ service_ports | length }} services stopped successfully

          TO RESTART SERVICES:
          ansible-playbook playbooks/deploy-all-services.yml

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        dest: "{{ project_root }}/SHUTDOWN_SUMMARY.txt"
        mode: '0644'
      failed_when: false
      tags:
        - logging

    # ========================================
    # PHASE 9: DISPLAY FINAL STATUS
    # ========================================

    - name: "âœ… Calculate shutdown statistics"
      set_fact:
        successfully_stopped: "{{ port_verification.results | rejectattr('failed', 'equalto', true) | list | length }}"
        failed_to_stop: "{{ port_verification.results | selectattr('failed', 'equalto', true) | list | length }}"
      tags:
        - summary

    - name: "âœ… Display final shutdown status"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ðŸ›‘ SHUTDOWN COMPLETED!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… Successfully Stopped: {{ successfully_stopped }}/{{ service_ports | length }}"
          - "{% if failed_to_stop | int > 0 %}âš ï¸ Failed to Stop: {{ failed_to_stop }}{% endif %}"
          - ""
          - "ðŸ“„ Shutdown Summary: {{ project_root }}/SHUTDOWN_SUMMARY.txt"
          - "ðŸ“‹ Logs Archived: {{ project_root }}/logs/"
          - ""
          - "ðŸ”„ To restart services:"
          - "   ansible-playbook playbooks/deploy-all-services.yml"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags:
        - always

    - name: "âš ï¸ Warning if some services still running"
      debug:
        msg: "WARNING: Some services may still be running. Check manually with: lsof -i :5000-5008"
      when: failed_to_stop | int > 0
      tags:
        - always

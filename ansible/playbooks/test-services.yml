# Test Services Playbook
# Smart Attendance Management System
# Performs automated testing of all deployed microservices

---
- name: Test All Microservices
  hosts: localhost
  gather_facts: yes

  vars:
    # Services to test with their endpoints
    services:
      - name: auth-service
        port: 5007
        endpoints:
          - path: "/api/auth/health"
            expected_status: [200, 404]
            description: "Health check"
          - path: "/"
            expected_status: [200, 404]
            description: "Root endpoint"

      - name: service-registry
        port: 5008
        endpoints:
          - path: "/services"
            expected_status: [200]
            description: "List services"
          - path: "/"
            expected_status: [200, 404]
            description: "Root endpoint"

      - name: student-service
        port: 5001
        endpoints:
          - path: "/api/students/health"
            expected_status: [200, 404]
            description: "Health check"
          - path: "/"
            expected_status: [200, 404]
            description: "Root endpoint"

      - name: course-service
        port: 5002
        endpoints:
          - path: "/api/courses/health"
            expected_status: [200, 404]
            description: "Health check"
          - path: "/"
            expected_status: [200, 404]
            description: "Root endpoint"

      - name: attendance-service
        port: 5005
        endpoints:
          - path: "/api/attendance/health"
            expected_status: [200, 404]
            description: "Health check"
          - path: "/"
            expected_status: [200, 404]
            description: "Root endpoint"

      - name: api-gateway
        port: 5000
        endpoints:
          - path: "/"
            expected_status: [200]
            description: "Gateway health check"

  tasks:
    # ========================================
    # PHASE 1: PRE-TEST CHECKS
    # ========================================

    - name: "ğŸ§ª Display test start message"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ§ª TESTING SMART ATTENDANCE MICROSERVICES"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ“Š Total Services: {{ services | length }}"
          - "â° Test Started: {{ ansible_date_time.iso8601 }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags:
        - always

    # ========================================
    # PHASE 2: PORT AVAILABILITY TESTS
    # ========================================

    - name: "ğŸ” Test 1: Check if service ports are listening"
      wait_for:
        port: "{{ item.port }}"
        state: started
        timeout: 5
        delay: 0
      loop: "{{ services }}"
      loop_control:
        label: "{{ item.name }}:{{ item.port }}"
      register: port_test_results
      failed_when: false
      tags:
        - port_test

    - name: "ğŸ“Š Port test summary"
      debug:
        msg: "{{ item.item.name }}: {{ 'LISTENING âœ…' if not item.failed else 'NOT LISTENING âŒ' }}"
      loop: "{{ port_test_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      tags:
        - port_test

    # ========================================
    # PHASE 3: HTTP ENDPOINT TESTS
    # ========================================

    - name: "ğŸŒ Test 2: HTTP endpoint tests for {{ item.0.name }}"
      uri:
        url: "http://localhost:{{ item.0.port }}{{ item.1.path }}"
        method: GET
        status_code: "{{ item.1.expected_status }}"
        timeout: 10
        return_content: yes
      loop: "{{ services | subelements('endpoints') }}"
      loop_control:
        label: "{{ item.0.name }}{{ item.1.path }}"
      register: http_test_results
      failed_when: false
      retries: 2
      delay: 1
      tags:
        - http_test

    - name: "ğŸ“Š HTTP test summary"
      debug:
        msg: "{{ item.item.0.name }}{{ item.item.1.path }}: {{ 'PASSED âœ…' if not item.failed else 'FAILED âŒ' }}"
      loop: "{{ http_test_results.results }}"
      loop_control:
        label: "{{ item.item.0.name }}{{ item.item.1.path }}"
      tags:
        - http_test

    # ========================================
    # PHASE 4: SERVICE-SPECIFIC TESTS
    # ========================================

    - name: "ğŸ” Test 3: Auth Service - Login Test"
      uri:
        url: "http://localhost:5007/api/auth/login"
        method: POST
        body_format: json
        body:
          username: "admin"
          password: "admin123"
        status_code: [200, 404]
        timeout: 5
      register: auth_login_test
      failed_when: false
      tags:
        - functional_test
        - auth_test

    - name: "ğŸ“Š Auth login test result"
      debug:
        msg: "Auth Service Login: {{ 'PASSED âœ…' if not auth_login_test.failed else 'FAILED âŒ' }}"
      tags:
        - functional_test

    - name: "ğŸ“ Test 4: Student Service - List Students"
      uri:
        url: "http://localhost:5001/api/students/students"
        method: GET
        status_code: [200, 401, 404]
        timeout: 5
      register: student_list_test
      failed_when: false
      tags:
        - functional_test
        - student_test

    - name: "ğŸ“Š Student list test result"
      debug:
        msg: "Student Service List: {{ 'PASSED âœ…' if not student_list_test.failed else 'FAILED âŒ' }}"
      tags:
        - functional_test

    - name: "ğŸ“š Test 5: Course Service - List Courses"
      uri:
        url: "http://localhost:5002/api/courses/courses"
        method: GET
        status_code: [200, 401, 404]
        timeout: 5
      register: course_list_test
      failed_when: false
      tags:
        - functional_test
        - course_test

    - name: "ğŸ“Š Course list test result"
      debug:
        msg: "Course Service List: {{ 'PASSED âœ…' if not course_list_test.failed else 'FAILED âŒ' }}"
      tags:
        - functional_test

    - name: "ğŸ“ Test 6: Service Registry - List Services"
      uri:
        url: "http://localhost:5008/services"
        method: GET
        status_code: [200, 404]
        timeout: 5
      register: registry_test
      failed_when: false
      tags:
        - functional_test
        - registry_test

    - name: "ğŸ“Š Service registry test result"
      debug:
        msg: "Service Registry: {{ 'PASSED âœ…' if not registry_test.failed else 'FAILED âŒ' }}"
      tags:
        - functional_test

    # ========================================
    # PHASE 5: PERFORMANCE TESTS
    # ========================================

    - name: "âš¡ Test 7: Response Time Test"
      uri:
        url: "http://localhost:{{ item.port }}/"
        method: GET
        status_code: [200, 401, 404]
        timeout: 5
      loop: "{{ services }}"
      loop_control:
        label: "{{ item.name }}"
      register: performance_test_results
      failed_when: false
      tags:
        - performance_test

    - name: "ğŸ“Š Response time summary"
      debug:
        msg: "{{ item.item.name }}: Response time {{ item.elapsed | default('N/A') }}s {{ '(FAST âœ…)' if item.elapsed | default(999) < 2 else '(SLOW âš ï¸)' }}"
      loop: "{{ performance_test_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: not item.failed
      tags:
        - performance_test

    # ========================================
    # PHASE 6: GENERATE TEST REPORT
    # ========================================

    - name: "ğŸ“Š Calculate test statistics"
      set_fact:
        total_tests: "{{ (http_test_results.results | length) + 4 }}"
        passed_tests: "{{ (http_test_results.results | rejectattr('failed', 'equalto', true) | list | length) + ([auth_login_test, student_list_test, course_list_test, registry_test] | rejectattr('failed', 'equalto', true) | list | length) }}"
        failed_tests: "{{ (http_test_results.results | selectattr('failed', 'equalto', true) | list | length) + ([auth_login_test, student_list_test, course_list_test, registry_test] | selectattr('failed', 'equalto', true) | list | length) }}"
      tags:
        - summary

    - name: "ğŸ“ Write detailed test report"
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          SMART ATTENDANCE SYSTEM - TEST REPORT
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          Test Execution Time: {{ ansible_date_time.iso8601 }}
          Test Executor: {{ ansible_user_id }}
          Platform: {{ ansible_system }}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TEST SUMMARY
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          Total Tests: {{ total_tests }}
          Passed: {{ passed_tests }}
          Failed: {{ failed_tests }}
          Success Rate: {{ (passed_tests | int / total_tests | int * 100) | round(1) }}%

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PORT AVAILABILITY TESTS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% for item in port_test_results.results %}
          {{ item.item.name }} (Port {{ item.item.port }}): {{ 'PASS âœ…' if not item.failed else 'FAIL âŒ' }}
          {% endfor %}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          HTTP ENDPOINT TESTS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% for item in http_test_results.results %}
          {{ item.item.0.name }}{{ item.item.1.path }}: {{ 'PASS âœ…' if not item.failed else 'FAIL âŒ' }}
          {% endfor %}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          FUNCTIONAL TESTS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Auth Service Login: {{ 'PASS âœ…' if not auth_login_test.failed else 'FAIL âŒ' }}
          Student Service List: {{ 'PASS âœ…' if not student_list_test.failed else 'FAIL âŒ' }}
          Course Service List: {{ 'PASS âœ…' if not course_list_test.failed else 'FAIL âŒ' }}
          Service Registry: {{ 'PASS âœ…' if not registry_test.failed else 'FAIL âŒ' }}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PERFORMANCE METRICS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% for item in performance_test_results.results %}
          {% if not item.failed %}
          {{ item.item.name }}: {{ item.elapsed | default('N/A') }}s
          {% endif %}
          {% endfor %}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          RECOMMENDATIONS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% if failed_tests | int > 0 %}
          âš ï¸ Some tests failed. Please check:
          1. All services are running
          2. No port conflicts
          3. Service logs for errors
          4. Network connectivity

          Commands to diagnose:
          - Check logs: tail -f /opt/smart-attendance/*/service.log
          - Check ports: lsof -i :5000-5008
          - Restart services: ansible-playbook playbooks/deploy-all-services.yml
          {% else %}
          âœ… All tests passed successfully!
          System is fully operational.
          {% endif %}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        dest: "/opt/smart-attendance/TEST_REPORT.txt"
        mode: '0644'
      become: yes
      failed_when: false
      tags:
        - summary

    # ========================================
    # PHASE 7: DISPLAY FINAL RESULTS
    # ========================================

    - name: "âœ… Display final test results"
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ§ª TEST EXECUTION COMPLETED!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ“Š Total Tests: {{ total_tests }}"
          - "âœ… Passed: {{ passed_tests }}"
          - "âŒ Failed: {{ failed_tests }}"
          - "ğŸ“ˆ Success Rate: {{ (passed_tests | int / total_tests | int * 100) | round(1) }}%"
          - ""
          - "{% if failed_tests | int == 0 %}ğŸ‰ ALL TESTS PASSED! System is fully operational.{% else %}âš ï¸ Some tests failed. Check /opt/smart-attendance/TEST_REPORT.txt{% endif %}"
          - ""
          - "ğŸ“„ Detailed Report: /opt/smart-attendance/TEST_REPORT.txt"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      tags:
        - always

    - name: "âš ï¸ List failed tests (if any)"
      debug:
        msg: "FAILED: {{ item.item.0.name }}{{ item.item.1.path }}"
      loop: "{{ http_test_results.results }}"
      when: item.failed
      loop_control:
        label: "{{ item.item.0.name }}"
      tags:
        - always
